(function (y) {
    function n(G, F, E, D) {
        var C = 0, B = 0, A = 0, E = (E || "(").toString(), D = (D || ")").toString(), z;
        for (z = 0; z < G.length; z++) {
            var l = G[z];
            if (l.indexOf(E, C) > l.indexOf(D, C) || ~l.indexOf(E, C) && !~l.indexOf(D, C) || !~l.indexOf(E, C) && ~l.indexOf(D, C)) {
                B = l.indexOf(E, C), A = l.indexOf(D, C);
                if (~B && !~A || !~B && ~A) {
                    var k = G.slice(0, (z || 1) + 1).join(F);
                    G = [k].concat(G.slice((z || 1) + 1))
                }
                C = (A > B ? A : B) + 1, z = 0
            } else {
                C = 0
            }
        }
        return G
    }

    function o(E, D) {
        var C, B = 0, A = "";
        while (C = E.substr(B).match(/[^\w\d\- %@&]*\*[^\w\d\- %@&]*/)) {
            B = C.index + C[0].length, C[0] = C[0].replace(/^\*/, "([_.()!\\ %@&a-zA-Z0-9-]+)"), A += E.substr(0, C.index) + C[0]
        }
        E = A += E.substr(B);
        var z = E.match(/:([^\/]+)/ig), l, k;
        if (z) {
            k = z.length;
            for (var i = 0; i < k; i++) {
                l = z[i], l.slice(0, 2) === "::" ? E = l.slice(1) : E = E.replace(l, p(l, D))
            }
        }
        return E
    }

    function p(f, e, h) {
        h = f;
        for (var g in e) {
            if (e.hasOwnProperty(g)) {
                h = e[g](f);
                if (h !== f) {
                    break
                }
            }
        }
        return h === f ? "([._a-zA-Z0-9-%()]+)" : h
    }

    function q(g, f, j) {
        if (!g.length) {
            return j()
        }
        var i = 0;
        (function h() {
            f(g[i], function (a) {
                a || a === !1 ? (j(a), j = function () {
                }) : (i += 1, i === g.length ? j() : h())
            })
        })()
    }

    function r(f) {
        var e = [];
        for (var h = 0, g = f.length; h < g; h++) {
            e = e.concat(f[h])
        }
        return e
    }

    function t(e, d) {
        for (var f = 0; f < e.length; f += 1) {
            if (d(e[f], f, e) === !1) {
                return
            }
        }
    }

    function w() {
        return x.hash === "" || x.hash === "#"
    }

    var x = document.location, v = {
        mode: "modern", hash: x.hash, history: !1, check: function () {
            var b = x.hash;
            b != this.hash && (this.hash = b, this.onHashChanged())
        }, fire: function () {
            this.mode === "modern" ? this.history === !0 ? window.onpopstate() : window.onhashchange() : this.onHashChanged()
        }, init: function (g, e) {
            function i(f) {
                for (var d = 0, k = u.listeners.length; d < k; d++) {
                    u.listeners[d](f)
                }
            }

            var j = this;
            this.history = e, u.listeners || (u.listeners = []);
            if ("onhashchange" in window && (document.documentMode === undefined || document.documentMode > 7)) {
                this.history === !0 ? setTimeout(function () {
                    window.onpopstate = i
                }, 500) : window.onhashchange = i, this.mode = "modern"
            } else {
                var h = document.createElement("iframe");
                h.id = "state-frame", h.style.display = "none", document.body.appendChild(h), this.writeFrame(""), "onpropertychange" in document && "attachEvent" in document && document.attachEvent("onpropertychange", function () {
                    event.propertyName === "location" && j.check()
                }), window.setInterval(function () {
                    j.check()
                }, 50), this.onHashChanged = i, this.mode = "legacy"
            }
            u.listeners.push(g);
            return this.mode
        }, destroy: function (e) {
            if (!!u && !!u.listeners) {
                var d = u.listeners;
                for (var f = d.length - 1; f >= 0; f--) {
                    d[f] === e && d.splice(f, 1)
                }
            }
        }, setHash: function (b) {
            this.mode === "legacy" && this.writeFrame(b), this.history === !0 ? (window.history.pushState({}, document.title, b), this.fire()) : x.hash = b[0] === "/" ? b : "/" + b;
            return this
        }, writeFrame: function (e) {
            var d = document.getElementById("state-frame"), f = d.contentDocument || d.contentWindow.document;
            f.open(), f.write("<script>_hash = '" + e + "'; onload = parent.listener.syncHash;<script>"), f.close()
        }, syncHash: function () {
            var b = this._hash;
            b != x.hash && (x.hash = b);
            return this
        }, onHashChanged: function () {
        }
    }, u = y.Router = function (b) {
        if (this instanceof u) {
            this.params = {}, this.routes = {}, this.methods = ["on", "once", "after", "before"], this.scope = [], this._methods = {}, this._insert = this.insert, this.insert = this.insertEx, this.historySupport = (window.history != null ? window.history.pushState : null) != null, this.configure(), this.mount(b || {})
        } else {
            return new u(b)
        }
    };
    u.prototype.init = function (b) {
        var d = this, c;
        this.handler = function (f) {
            var e = f && f.newURL || window.location.hash, g = d.history === !0 ? d.getPath() : e.replace(/.*#/, "");
            d.dispatch("on", g.charAt(0) === "/" ? g : "/" + g)
        }, v.init(this.handler, this.history), this.history === !1 ? w() && b ? x.hash = b : w() || d.dispatch("on", "/" + x.hash.replace(/^(#\/|#|\/)/, "")) : (this.convert_hash_in_init ? (c = w() && b ? b : w() ? null : x.hash.replace(/^#/, ""), c && window.history.replaceState({}, document.title, c)) : c = this.getPath(), (c || this.run_in_init === !0) && this.handler());
        return this
    }, u.prototype.explode = function () {
        var b = this.history === !0 ? this.getPath() : x.hash;
        b.charAt(1) === "/" && (b = b.slice(1));
        return b.slice(1, b.length).split("/")
    }, u.prototype.setRoute = function (f, d, h) {
        var g = this.explode();
        typeof f == "number" && typeof d == "string" ? g[f] = d : typeof h == "string" ? g.splice(f, d, s) : g = [f], v.setHash(g.join("/"));
        return g
    }, u.prototype.insertEx = function (f, e, h, g) {
        f === "once" && (f = "on", h = function (d) {
            var c = !1;
            return function () {
                if (!c) {
                    c = !0;
                    return d.apply(this, arguments)
                }
            }
        }(h));
        return this._insert(f, e, h, g)
    }, u.prototype.getRoute = function (e) {
        var d = e;
        if (typeof e == "number") {
            d = this.explode()[e]
        } else {
            if (typeof e == "string") {
                var f = this.explode();
                d = f.indexOf(e)
            } else {
                d = this.explode()
            }
        }
        return d
    }, u.prototype.destroy = function () {
        v.destroy(this.handler);
        return this
    }, u.prototype.getPath = function () {
        var b = window.location.pathname;
        b.substr(0, 1) !== "/" && (b = "/" + b);
        return b
    };
    var m = /\?.*/;
    u.prototype.configure = function (d) {
        d = d || {};
        for (var c = 0; c < this.methods.length; c++) {
            this._methods[this.methods[c]] = !0
        }
        this.recurse = d.recurse || this.recurse || !1, this.async = d.async || !1, this.delimiter = d.delimiter || "/", this.strict = typeof d.strict == "undefined" ? !0 : d.strict, this.notfound = d.notfound, this.resource = d.resource, this.history = d.html5history && this.historySupport || !1, this.run_in_init = this.history === !0 && d.run_handler_in_init !== !1, this.convert_hash_in_init = this.history === !0 && d.convert_hash_in_init !== !1, this.every = {
            after: d.after || null,
            before: d.before || null,
            on: d.on || null
        };
        return this
    }, u.prototype.param = function (e, d) {
        e[0] !== ":" && (e = ":" + e);
        var f = new RegExp(e, "g");
        this.params[e] = function (b) {
            return b.replace(f, d.source || d)
        };
        return this
    }, u.prototype.on = u.prototype.route = function (f, e, h) {
        var g = this;
        !h && typeof e == "function" && (h = e, e = f, f = "on");
        if (Array.isArray(e)) {
            return e.forEach(function (a) {
                g.on(f, a, h)
            })
        }
        e.source && (e = e.source.replace(/\\\//ig, "/"));
        if (Array.isArray(f)) {
            return f.forEach(function (b) {
                g.on(b.toLowerCase(), e, h)
            })
        }
        e = e.split(new RegExp(this.delimiter)), e = n(e, this.delimiter), this.insert(f, this.scope.concat(e), h)
    }, u.prototype.path = function (f, e) {
        var h = this, g = this.scope.length;
        f.source && (f = f.source.replace(/\\\//ig, "/")), f = f.split(new RegExp(this.delimiter)), f = n(f, this.delimiter), this.scope = this.scope.concat(f), e.call(this, this), this.scope.splice(g, f.length)
    }, u.prototype.dispatch = function (j, i, C) {
        function k() {
            B.last = A.after, B.invoke(B.runlist(A), B, C)
        }

        var B = this, A = this.traverse(j, i.replace(m, ""), this.routes, ""), z = this._invoked, l;
        this._invoked = !0;
        if (!A || A.length === 0) {
            this.last = [], typeof this.notfound == "function" && this.invoke([this.notfound], {method: j, path: i}, C);
            return !1
        }
        this.recurse === "forward" && (A = A.reverse()), l = this.every && this.every.after ? [this.every.after].concat(this.last) : [this.last];
        if (l && l.length > 0 && z) {
            this.async ? this.invoke(l, this, k) : (this.invoke(l, this), k());
            return !0
        }
        k();
        return !0
    }, u.prototype.invoke = function (g, f, j) {
        var i = this, h;
        this.async ? (h = function (b, a) {
            if (Array.isArray(b)) {
                return q(b, h, a)
            }
            typeof b == "function" && b.apply(f, (g.captures || []).concat(a))
        }, q(g, h, function () {
            j && j.apply(f, arguments)
        })) : (h = function (a) {
            if (Array.isArray(a)) {
                return t(a, h)
            }
            if (typeof a == "function") {
                return a.apply(f, g.captures || [])
            }
            typeof a == "string" && i.resource && i.resource[a].apply(f, g.captures || [])
        }, t(g, h))
    }, u.prototype.traverse = function (L, K, J, I, H) {
        function A(f) {
            function h(d) {
                for (var c = d.length - 1; c >= 0; c--) {
                    Array.isArray(d[c]) ? (h(d[c]), d[c].length === 0 && d.splice(c, 1)) : H(d[c]) || d.splice(c, 1)
                }
            }

            function e(b) {
                var j = [];
                for (var i = 0; i < b.length; i++) {
                    j[i] = Array.isArray(b[i]) ? e(b[i]) : b[i]
                }
                return j
            }

            if (!H) {
                return f
            }
            var g = e(f);
            g.matched = f.matched, g.captures = f.captures, g.after = f.after.filter(H), h(g);
            return g
        }

        var G = [], F, E, D, C, B;
        if (K === this.delimiter && J[L]) {
            C = [[J.before, J[L]].filter(Boolean)], C.after = [J.after].filter(Boolean), C.matched = !0, C.captures = [];
            return A(C)
        }
        for (var z in J) {
            if (J.hasOwnProperty(z) && (!this._methods[z] || this._methods[z] && typeof J[z] == "object" && !Array.isArray(J[z]))) {
                F = E = I + this.delimiter + z, this.strict || (E += "[" + this.delimiter + "]?"), D = K.match(new RegExp("^" + E));
                if (!D) {
                    continue
                }
                if (D[0] && D[0] == K && J[z][L]) {
                    C = [[J[z].before, J[z][L]].filter(Boolean)], C.after = [J[z].after].filter(Boolean), C.matched = !0, C.captures = D.slice(1), this.recurse && J === this.routes && (C.push([J.before, J.on].filter(Boolean)), C.after = C.after.concat([J.after].filter(Boolean)));
                    return A(C)
                }
                C = this.traverse(L, K, J[z], F);
                if (C.matched) {
                    C.length > 0 && (G = G.concat(C)), this.recurse && (G.push([J[z].before, J[z].on].filter(Boolean)), C.after = C.after.concat([J[z].after].filter(Boolean)), J === this.routes && (G.push([J.before, J.on].filter(Boolean)), C.after = C.after.concat([J.after].filter(Boolean)))), G.matched = !0, G.captures = C.captures, G.after = C.after;
                    return A(G)
                }
            }
        }
        return !1
    }, u.prototype.insert = function (E, D, C, B) {
        var A, z, l, k, j;
        D = D.filter(function (b) {
            return b && b.length > 0
        }), B = B || this.routes, j = D.shift(), /\:|\*/.test(j) && !/\\d|\\w/.test(j) && (j = o(j, this.params));
        if (D.length > 0) {
            B[j] = B[j] || {};
            return this.insert(E, D, C, B[j])
        }
        if (!!j || !!D.length || B !== this.routes) {
            z = typeof B[j], l = Array.isArray(B[j]);
            if (B[j] && !l && z == "object") {
                A = typeof B[j][E];
                switch (A) {
                    case"function":
                        B[j][E] = [B[j][E], C];
                        return;
                    case"object":
                        B[j][E].push(C);
                        return;
                    case"undefined":
                        B[j][E] = C;
                        return
                }
            } else {
                if (z == "undefined") {
                    k = {}, k[E] = C, B[j] = k;
                    return
                }
            }
            throw new Error("Invalid route context: " + z)
        }
        A = typeof B[E];
        switch (A) {
            case"function":
                B[E] = [B[E], C];
                return;
            case"object":
                B[E].push(C);
                return;
            case"undefined":
                B[E] = C;
                return
        }
    }, u.prototype.extend = function (g) {
        function h(b) {
            f._methods[b] = !0, f[b] = function () {
                var a = arguments.length === 1 ? [b, ""] : [b];
                f.on.apply(f, a.concat(Array.prototype.slice.call(arguments)))
            }
        }

        var f = this, j = g.length, i;
        for (i = 0; i < j; i++) {
            h(g[i])
        }
    }, u.prototype.runlist = function (d) {
        var c = this.every && this.every.before ? [this.every.before].concat(r(d)) : r(d);
        this.every && this.every.on && c.push(this.every.on), c.captures = d.captures, c.source = d.source;
        return c
    }, u.prototype.mount = function (g, f) {
        function i(a, B) {
            var A = a, z = a.split(j.delimiter), l = typeof g[a], k = z[0] === "" || !j._methods[z[0]],
                c = k ? "on" : A;
            k && (A = A.slice((A.match(new RegExp("^" + j.delimiter)) || [""])[0].length), z.shift());
            k && l === "object" && !Array.isArray(g[a]) ? (B = B.concat(z), j.mount(g[a], B)) : (k && (B = B.concat(A.split(j.delimiter)), B = n(B, j.delimiter)), j.insert(c, B, g[a]))
        }

        if (!!g && typeof g == "object" && !Array.isArray(g)) {
            var j = this;
            f = f || [], Array.isArray(f) || (f = f.split(j.delimiter));
            for (var h in g) {
                g.hasOwnProperty(h) && i(h, f.slice(0))
            }
        }
    }
})(typeof exports == "object" ? exports : window);